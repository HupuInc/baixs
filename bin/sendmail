#!/bin/env node

var request = require('request');
var nodemailer = require('nodemailer');
var auth = require('../api.production.js').auth;
var smtpConfig = require('../api.production.js').smtp;

var BAIXS = 'http://baixs.pub.hupu.com/api/';
var transporter = nodemailer.createTransport(smtpConfig);
var end = new Date().valueOf() / 1000;
var start = end - 86400;

function sendMail(data) {
  var hosts = {};
  data.forEach(function(d) {
    hosts[d.data.hostname] = "";
  });
  sortedHosts = Object.keys(hosts).sort();

  transporter.sendMail({
    from: 'monitor@hupu.com',
    to: 'group_xitong@hupu.com',
    subject: '过去24小时内,进入过维护状态的主机',
    text: sortedHosts.join('\n')
  });
}

request(BAIXS + 'history?start=' + start + '&end=' + end, auth, function(err, res, body) {
  var data = JSON.parse(body);
  request(BAIXS + 'benchs', auth, function(e, r, b) {
    data = data.concat(JSON.parse(r.body));
    sendMail(data);
  });
});
